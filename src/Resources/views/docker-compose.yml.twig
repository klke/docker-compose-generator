version: '2'
services:

{% if services.mysql.enabled %}
  mysql:
      container_name: {{ mutex }}-mysql
      image: "mysql:5.7"
      volumes:
          - ./docker/mysql/data:/var/lib/mysql
          - ./docker/mysql/mysqld.cnf:/etc/mysql/mysql.conf.d/mysqld.cnf
      expose:
          - 33661
      ports:
          - {{ services.mysql.port }}:3306
      environment:
          MYSQL_ALLOW_EMPTY_PASSWORD: 1
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: symfony
          MYSQL_USER: symfony
          MYSQL_PASSWORD: root
          MYSQL_ROOT_HOST: "%"
      networks:
          - symfony
{% endif %}

{% if services.redis.enabled %}
  redis:
      container_name: {{ mutex }}-redis
      image: "redis:3.2"
      expose:
          - {{ services.redis.port }}
      ports:
          - {{ services.redis.port }}:6379
      networks:
          - symfony
{% endif %}

{% if services.elasticsearch.enabled %}
  elasticsearch:
        container_name: {{ mutex }}-elastic
        image: "docker.elastic.co/elasticsearch/elasticsearch:6.8.5"
        expose:
          - {{ services.elasticsearch.port }}
        ports:
          - {{ services.elasticsearch.port }}:9200
        networks:
          - symfony
{% endif %}

{% if services.kibana.enabled %}
  kibana:
        container_name: {{ mutex }}-kibana
        image: docker.elastic.co/kibana/kibana:6.8.6
        environment:
              SERVER_HOST: localhost
              ELASTICSEARCH_HOSTS: http://elasticsearch:{{ services.elasticsearch.port }}
        expose:
          - {{ services.kibana.port }}
        ports:
          - {{ services.kibana.port }}:5601
        depends_on:
          - elasticsearch
{% endif %}

{% if services.mongodb.enabled %}
  mongodb:
        container_name: {{ mutex }}-mongodb
        image: mongo:latest
        environment:
           - MONGO_DATA_DIR=/data/db
           - MONGO_LOG_DIR=/dev/null
           - MONGODB_USER="guest"
           - MONGODB_PASS="guest"
        volumes:
           - ./docker/mongodb/data/db:/data/db
        expose:
           - {{ services.mongodb.port }}
        ports:
           - {{ services.mongodb.port }}:27017
        command: mongod --smallfiles --logpath=/dev/null # --quiet
        networks:
          - symfony
{% endif %}

{% if services.rabbitmq.enabled %}
  rabbitmq:
        container_name: {{ mutex }}-rabbitmq
        image: "rabbitmq:latest"
        volumes:
          - "./docker/rabbitmq/enabled_plugins:/etc/rabbitmq/enabled_plugins"
        expose:
          - {{ services.rabbitmq.extra_ports.rabbitmq_manager }}
        ports:
          - {{ services.rabbitmq.extra_ports.rabbitmq_manager }}:15672
          - {{ services.rabbitmq.port }}:5672
        environment:
          RABBITMQ_ERLANG_COOKIE: "SWQOKODSQALRPCLNMEQG"
          RABBITMQ_DEFAULT_USER: "guest"
          RABBITMQ_DEFAULT_PASS: "guest"
          RABBITMQ_DEFAULT_VHOST: "mainrabbit"
        networks:
          - symfony
{% endif %}

networks:
    symfony:
        driver: bridge
